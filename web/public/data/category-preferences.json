[
  {
    "path": "/home/runner/work/code-wiki/code-wiki/wiki/preferences/_index.md",
    "relativePath": "preferences/_index.md",
    "title": "Preferences Index",
    "description": "User and project preference configurations",
    "tags": [
      "index",
      "preferences",
      "configuration"
    ],
    "content": "\n# Preferences\n\nThis category contains user and project preference configurations.\n\n## What belongs here\n\n- Tech stack preferences\n- UI/UX guidelines\n- Deployment configurations\n- Development environment setups\n- Architectural conventions\n- Tool and library choices\n\n## Adding new preferences\n\nCreate a new `.md` file in this directory for each preference set you want to document.\n",
    "contentPreview": "# Preferences  This category contains user and project preference configurations.  ## What belongs here  - Tech stack preferences - UI/UX guidelines - Deployment configurations - Development environment setups - Architectural conventions - Tool and library choices  ## Adding new preferences  Create",
    "category": "preferences"
  },
  {
    "path": "/home/runner/work/code-wiki/code-wiki/wiki/preferences/gcp-cloud-run-deployment.md",
    "relativePath": "preferences/gcp-cloud-run-deployment.md",
    "title": "gcp-cloud-run-deployment",
    "tags": [],
    "content": "# Google Cloud Run Deployment Guide\n\nA comprehensive guide for deploying Python/FastAPI backends to Google Cloud Run via GitHub Actions.\n\n## Prerequisites\n\n- Google Cloud account with billing enabled\n- GitHub repository\n- `gcloud` CLI installed locally\n\n## Initial GCP Setup\n\n### 1. Create or Select a Project\n\n```bash\n# List existing projects\ngcloud projects list\n\n# Create a new project (optional)\ngcloud projects create YOUR_PROJECT_ID --name=\"Your Project Name\"\n\n# Set active project\ngcloud config set project YOUR_PROJECT_ID\n```\n\n### 2. Enable Required APIs\n\n```bash\ngcloud services enable \\\n  run.googleapis.com \\\n  artifactregistry.googleapis.com \\\n  cloudbuild.googleapis.com \\\n  --project=YOUR_PROJECT_ID\n```\n\n### 3. Create Artifact Registry Repository\n\n```bash\ngcloud artifacts repositories create YOUR_REPO_NAME \\\n  --repository-format=docker \\\n  --location=us-central1 \\\n  --description=\"Docker images for your app\" \\\n  --project=YOUR_PROJECT_ID\n```\n\n### 4. Create Service Account for GitHub Actions\n\n```bash\n# Create the service account\ngcloud iam service-accounts create github-actions \\\n  --display-name=\"GitHub Actions\" \\\n  --project=YOUR_PROJECT_ID\n\n# Store the email for convenience\nSA_EMAIL=\"github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com\"\n```\n\n### 5. Grant Required Permissions\n\n```bash\n# Cloud Run Admin - deploy services\ngcloud projects add-iam-policy-binding YOUR_PROJECT_ID \\\n  --member=\"serviceAccount:$SA_EMAIL\" \\\n  --role=\"roles/run.admin\"\n\n# Artifact Registry Writer - push Docker images\ngcloud projects add-iam-policy-binding YOUR_PROJECT_ID \\\n  --member=\"serviceAccount:$SA_EMAIL\" \\\n  --role=\"roles/artifactregistry.writer\"\n\n# Service Account User - deploy as compute service account\n# First, find your compute service account number:\ngcloud projects describe YOUR_PROJECT_ID --format=\"value(projectNumber)\"\n# Then grant permission (replace PROJECT_NUMBER):\ngcloud iam service-accounts add-iam-policy-binding \\\n  PROJECT_NUMBER-compute@developer.gserviceaccount.com \\\n  --member=\"serviceAccount:$SA_EMAIL\" \\\n  --role=\"roles/iam.serviceAccountUser\" \\\n  --project=YOUR_PROJECT_ID\n```\n\n### 6. Create and Download Service Account Key\n\n```bash\ngcloud iam service-accounts keys create ~/github-actions-key.json \\\n  --iam-account=github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com \\\n  --project=YOUR_PROJECT_ID\n\n# View the key (copy this for GitHub secrets)\ncat ~/github-actions-key.json\n\n# IMPORTANT: Delete the local key file after copying to GitHub\nrm ~/github-actions-key.json\n```\n\n## GitHub Repository Setup\n\n### Required Secrets\n\nGo to GitHub → Repository → Settings → Secrets and variables → Actions\n\nAdd these secrets:\n\n| Secret Name | Value |\n|-------------|-------|\n| `GCP_PROJECT_ID` | Your GCP project ID (e.g., `my-project-123`) |\n| `GCP_SA_KEY` | The entire JSON content of the service account key |\n| `ANTHROPIC_API_KEY` | (Optional) API key for Anthropic |\n| `GOOGLE_API_KEY` | (Optional) API key for Google AI |\n| `OPENAI_API_KEY` | (Optional) API key for OpenAI |\n| `PERPLEXITY_API_KEY` | (Optional) API key for Perplexity |\n\n## GitHub Actions Workflow\n\nCreate `.github/workflows/deploy-backend.yml`:\n\n```yaml\nname: Deploy Backend to Cloud Run\n\non:\n  push:\n    branches:\n      - main\n    paths:\n      - 'src/**'\n      - 'pyproject.toml'\n      - 'Dockerfile'\n      - '.github/workflows/deploy-backend.yml'\n  workflow_dispatch:  # Allow manual trigger\n\nenv:\n  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}\n  SERVICE_NAME: your-api-name\n  ARTIFACT_REPO: your-repo-name\n  REGION: us-central1\n\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n\n    permissions:\n      contents: read\n      id-token: write\n\n    steps:\n      - name: Checkout code\n        uses: actions/checkout@v4\n\n      - name: Authenticate to Google Cloud\n        uses: google-github-actions/auth@v2\n        with:\n          credentials_json: ${{ secrets.GCP_SA_KEY }}\n\n      - name: Set up Cloud SDK\n        uses: google-github-actions/setup-gcloud@v2\n        with:\n          project_id: ${{ env.PROJECT_ID }}\n\n      - name: Configure Docker for Artifact Registry\n        run: |\n          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet\n\n      - name: Build and push Docker image\n        run: |\n          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .\n          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }}\n\n      - name: Deploy to Cloud Run\n        env:\n          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}\n          GOOGLE_KEY: ${{ secrets.GOOGLE_API_KEY }}\n        run: |\n          gcloud run deploy ${{ env.SERVICE_NAME }} \\\n            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \\\n            --platform managed \\\n            --region ${{ env.REGION }} \\\n            --allow-unauthenticated \\\n            --set-env-vars \"ANTHROPIC_API_KEY=${ANTHROPIC_KEY},GOOGLE_API_KEY=${GOOGLE_KEY}\" \\\n            --memory 2Gi \\\n            --cpu 1 \\\n            --min-instances 0 \\\n            --max-instances 3 \\\n            --timeout 300 \\\n            --cpu-boost\n\n      - name: Get Cloud Run URL\n        id: get-url\n        run: |\n          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')\n          echo \"service_url=$URL\" >> $GITHUB_OUTPUT\n          echo \"Backend deployed to: $URL\"\n```\n\n## Dockerfile for FastAPI\n\n```dockerfile\nFROM python:3.11-slim\n\nWORKDIR /app\n\n# Install system dependencies\nRUN apt-get update && apt-get install -y \\\n    gcc \\\n    && rm -rf /var/lib/apt/lists/*\n\n# Copy project files\nCOPY pyproject.toml .\nCOPY src/ ./src/\nCOPY config.yaml .  # If you have a config file\n\n# Install Python dependencies\nRUN pip install --no-cache-dir -e .\n\n# Download spaCy model if using NER\nRUN python -m spacy download en_core_web_sm\n\n# Create any needed directories\nRUN mkdir -p ./data\n\n# Expose port (Cloud Run uses PORT env var)\nEXPOSE 8080\n\n# Set Python path\nENV PYTHONPATH=/app\n\n# Disable Python buffering for better logging\nENV PYTHONUNBUFFERED=1\n\n# Run the API server - use shell form to respect PORT env var\nCMD uvicorn src.api:app --host 0.0.0.0 --port ${PORT:-8080}\n```\n\n## Common Dependencies (pyproject.toml)\n\nFor FastAPI with file uploads:\n\n```toml\ndependencies = [\n    \"fastapi>=0.109.0\",\n    \"uvicorn[standard]>=0.27.0\",\n    \"pydantic>=2.0.0\",\n    \"python-multipart>=0.0.6\",  # REQUIRED for file uploads (UploadFile)\n]\n```\n\n---\n\n## Troubleshooting Guide\n\n### Error: \"Container failed to start on port 8080\"\n\n**Symptoms:**\n- Deployment fails with timeout\n- \"Container failed to start and listen on the port\"\n\n**Solutions:**\n\n1. **Check logs for the actual error:**\n   ```bash\n   gcloud logging read \"resource.type=cloud_run_revision AND resource.labels.service_name=YOUR_SERVICE\" \\\n     --project=YOUR_PROJECT_ID \\\n     --limit=50 \\\n     --format=\"table(timestamp,severity,textPayload)\"\n   ```\n\n2. **Missing dependency:** Look for `RuntimeError` or `ImportError` in logs\n   - Common: `python-multipart` required for `UploadFile`\n   - Common: spaCy model not downloaded\n\n3. **Use lazy imports:** Heavy imports at module level can cause startup timeout\n   ```python\n   # Bad - imports at module level\n   from .heavy_module import HeavyClass\n\n   # Good - lazy import when needed\n   def get_heavy_class():\n       from .heavy_module import HeavyClass\n       return HeavyClass\n   ```\n\n4. **Increase memory/CPU:**\n   ```yaml\n   --memory 2Gi \\\n   --cpu 1 \\\n   --cpu-boost\n   ```\n\n### Error: \"Permission denied on Artifact Registry\"\n\n**Symptoms:**\n- `artifactregistry.repositories.uploadArtifacts denied`\n- `artifactregistry.repositories.downloadArtifacts denied`\n\n**Solution:**\n```bash\n# Grant Artifact Registry Writer role\ngcloud artifacts repositories add-iam-policy-binding YOUR_REPO_NAME \\\n  --location=us-central1 \\\n  --member=\"serviceAccount:github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com\" \\\n  --role=\"roles/artifactregistry.writer\" \\\n  --project=YOUR_PROJECT_ID\n```\n\n### Error: \"Project does not exist\" or Wrong Project\n\n**Symptoms:**\n- Deploys to wrong project\n- \"projects/XXX does not exist\"\n\n**Root Cause:** The service account key (`GCP_SA_KEY`) contains a `project_id` field that determines which project gcloud authenticates to.\n\n**Solution:**\n1. Verify the project in your key matches `GCP_PROJECT_ID`:\n   ```bash\n   # Check project in your key\n   cat your-key.json | grep project_id\n   ```\n\n2. If mismatched, create a NEW service account in the CORRECT project and update `GCP_SA_KEY`\n\n3. After updating secrets, push a new commit (re-running old workflows uses cached secrets)\n\n### Error: \"Cloud Run Service Agent must have permission to read image\"\n\n**Symptoms:**\n- Image pushed successfully\n- Deploy fails with 403 Forbidden on image pull\n\n**Root Cause:** Cross-project deployment - image in Project A, deploying to Project B\n\n**Solution:** Keep everything in one project. Create service account in the same project as Artifact Registry.\n\n### GitHub Actions Not Picking Up New Secrets\n\n**Symptoms:**\n- Updated secret but workflow still uses old value\n- Same error after changing secrets\n\n**Solution:**\n1. Push a new commit (don't just re-run workflow)\n2. The commit must change a file in the `paths` filter\n3. Or use `workflow_dispatch` and click \"Run workflow\" (after fresh page load)\n\n---\n\n## Useful Commands\n\n### View Cloud Run Logs\n```bash\ngcloud logging read \"resource.type=cloud_run_revision AND resource.labels.service_name=YOUR_SERVICE\" \\\n  --project=YOUR_PROJECT_ID \\\n  --limit=100\n```\n\n### List Cloud Run Services\n```bash\ngcloud run services list --project=YOUR_PROJECT_ID\n```\n\n### Get Service URL\n```bash\ngcloud run services describe YOUR_SERVICE \\\n  --region=us-central1 \\\n  --project=YOUR_PROJECT_ID \\\n  --format='value(status.url)'\n```\n\n### Delete a Service\n```bash\ngcloud run services delete YOUR_SERVICE \\\n  --region=us-central1 \\\n  --project=YOUR_PROJECT_ID\n```\n\n### List Artifact Registry Images\n```bash\ngcloud artifacts docker images list \\\n  us-central1-docker.pkg.dev/YOUR_PROJECT_ID/YOUR_REPO_NAME\n```\n\n### Check IAM Permissions\n```bash\ngcloud projects get-iam-policy YOUR_PROJECT_ID \\\n  --flatten=\"bindings[].members\" \\\n  --filter=\"bindings.members:serviceAccount:github-actions@YOUR_PROJECT_ID.iam.gserviceaccount.com\"\n```\n\n---\n\n## Connecting Frontend (Netlify)\n\nAfter successful deployment, connect your frontend to the Cloud Run backend:\n\n### 1. Get the Cloud Run URL\n\n```bash\ngcloud run services describe YOUR_SERVICE \\\n  --region=us-central1 \\\n  --project=YOUR_PROJECT_ID \\\n  --format='value(status.url)'\n```\n\nThis returns a URL like: `https://your-service-abc123-uc.a.run.app`\n\n### 2. Set Netlify Environment Variable\n\n1. Go to **Netlify** → Your Site → **Site configuration** → **Environment variables**\n2. Add a new variable:\n   - **Key:** `VITE_API_URL`\n   - **Value:** Your Cloud Run URL (e.g., `https://your-service-abc123-uc.a.run.app`)\n3. **Redeploy** your site for the change to take effect (Deploys → Trigger deploy → Deploy site)\n\n### 3. Use in Frontend Code\n\n```typescript\n// In your frontend code\nconst API_URL = import.meta.env.VITE_API_URL || 'http://localhost:8000';\n\n// Make API calls\nconst response = await fetch(`${API_URL}/health`);\n```\n\n### 4. Verify Connection\n\nTest the health endpoint directly:\n```bash\ncurl https://your-service-abc123-uc.a.run.app/health\n```\n\nShould return: `{\"status\":\"healthy\"}`\n\n---\n\n## Checklist for New Projects\n\n- [ ] GCP project created with billing enabled\n- [ ] APIs enabled (Cloud Run, Artifact Registry, Cloud Build)\n- [ ] Artifact Registry repository created\n- [ ] Service account created in the SAME project\n- [ ] Service account has: `run.admin`, `artifactregistry.writer`, `iam.serviceAccountUser`\n- [ ] Service account key generated and added to GitHub as `GCP_SA_KEY`\n- [ ] `GCP_PROJECT_ID` secret matches the project in the service account key\n- [ ] Dockerfile uses `PORT` environment variable (Cloud Run requirement)\n- [ ] `python-multipart` included if using file uploads\n- [ ] Heavy imports are lazy-loaded to avoid startup timeout\n",
    "contentPreview": "# Google Cloud Run Deployment Guide  A comprehensive guide for deploying Python/FastAPI backends to Google Cloud Run via GitHub Actions.  ## Prerequisites  - Google Cloud account with billing enabled - GitHub repository - `gcloud` CLI installed locally  ## Initial GCP Setup  ### 1. Create or Select",
    "category": "preferences"
  },
  {
    "path": "/home/runner/work/code-wiki/code-wiki/wiki/preferences/standard-setups.md",
    "relativePath": "preferences/standard-setups.md",
    "title": "standard-setups",
    "tags": [],
    "content": "#Standard setups#\n\nNote: this current file itself is available to the local mcp via .claude and is also stored in code-wiki/wiki/preferences.\n\n##Some standard components\n\nWhen asked to build something that can involve several components, either directly or indirectly, check here first to see if something similar has already been used here. Also check to see if something is available that is open source which covers the same basic functionality. If you find anything in either case, present that to the user.\n\n-> Standard AI chat tools - recently using Vercel AI SDK -\n\n-> Signup / Login flow - recently using what is currently in Create. Most recent version should also have forgot password flow\n\n-> Database storage when needed - for always on / fast starts currently using Google cloud, which is still on free tier for me for the next 12 months\n\n-> User credentials and document storage from apps - Cloudflare, which also has worker setups. Previously Supabase was used.\n\n-> Standard UI for saving chats - for now, saving as md files for what's in practice in ValueApe and Metabot. Future note is to see if Vercel has some similar functionality.\n\n-> same code base for web app and mobile - mainly using React with Capacitor. Sometimes using Github Actions for python functionality.\n\n-> Health checks - if the application is going to be used on Netlify or a mobile app, ask first and then integrate the health check currently in \nHealth checks are currently monitored in the free tier of Uptime Robot. \n\n-> API / AI usage tracking - had made my own app for this, in my GitHub as apiTracker. \n\n-> Ko-fi link - my most recent favorite version of this is in the ValueApe app.\n\n-> Doc import / export functions have been set up in the Novelizer app, the EthicalAIditor app and the StoryCircle-dev app\n\n## Standard overall user preferences\n\n-> I as a user generally prefer a code base that can also be relatively conveniently ported to multiple different platforms. So I generally want it work as a web app that I will also host and test on Netlify, and also for it to be relatively easy to wrap the same core code in any needed functionality for porting to iOS and Android and placing in those stores. \n\n-> smaller items that are suitable for users basic information is stored locally on the users' individual device, often via IndexDB\n\n-> Python scripts and similar for more advanced functionality than can conveniently run on the user's browser or mobile app.\n\n-> larger databases or files including custom LLM models I'm typically hosting on Google Drive\n\n->I overall prefer using app resources at either free tier or my current typically low paid tier for services. I currently have free or paid access on:\n\n- Google including Gemini (Pro, at $2/mo for intro 3 months as of Jan 2026)\n- Perplexity (pro at $20)\n- Figma (pro at $20)\n- Open AI (pro at $20)\n- Github Copilot (pro at $39, looking at reducing if I can)\n- Anthropic at $100/mo \n\n- Friendli.ai (free)\n- Supabase (free)\n- Hugging Face (free)\n- Open Router (free)\n\n-> LLMs and other similar items I'm typically preferring to reach on the free tier of Hugging Face\n\n-> For UI and UX, I typically prefer the app to provide some feedback to the user when a user's input search returns no info, or when the user inputs information that does not work for some reason.\n\n// ignore this for now, until the next double slashes. \n-> Pay attention to if the app being designed, redesigned or used is using real-world data or is creating new / mock / simulation data. Unless the app is for creating art such as fiction, or fill-in data for historical simulations, let the user know if and when this will be part of the design. //\n\n##Some standard features\n\n-> Unless otherwise asked, set up front end so that the web version can be viewed in a narrow browser, such as on a mobile device. \n\n-> Unless otherwise asked, if there are top menu nav items then have them move to a \"hamburger menu\" list when the web version of the app is viewed in a narrow browser, such as on a mobile device. \n\n-> Unless otherwise asked, a default saving and exporting setup is in /Users/jamesbeach/Documents/visual-studio-code/github-copilot/EthicalAIditor \n\n-> If there is any button or similar that causes an action, make the button has useful and appropriate label text\n\n##Standard things to check for\n\n-> When using Netlify, make sure the netlify.toml file will skip scanning for variables, example:\n\n[build.environment]\n  NODE_VERSION = \"20\"\n  SECRETS_SCAN_OMIT_KEYS = \"VITE_API_URL\"\n  \n-> If a requirements.txt file exists or is needed, make sure it matches the current needs for the app. It could be out of date.\n  \n-> Check for typescript errors that might also block Netlify builds \n\n-> For new projects or significant reworkings of existing projects, test via npm locally and fix issues before pushing changes to remote\n  \n-> Check and confirm ahead of time that there will not be CORS violations on Netlify\n\n-> CORS Configuration Gotcha: When using FastAPI (or similar) with CORSMiddleware, wildcard subdomain patterns like `https://*.netlify.app` do NOT work when `allow_credentials=True`. You must specify the exact domain:\n  - BAD: `allow_origins=[\"https://*.netlify.app\"]` with `allow_credentials=True`\n  - GOOD: `allow_origins=[\"https://my-app.netlify.app\"]` with `allow_credentials=True`\n  - ALTERNATIVE: Use `allow_origins=[\"*\"]` with `allow_credentials=False` (less secure, no cookies/auth headers)\n\n-> have a standard way set up for an agent to connect with my github repo if it's set to private\n\n-> For apps that are using data from other sources, once testing is complete and the app is going live such as to Netlify or similar, make sure that the app is using real data and not mock data ",
    "contentPreview": "#Standard setups#  Note: this current file itself is available to the local mcp via .claude and is also stored in code-wiki/wiki/preferences.  ##Some standard components  When asked to build something that can involve several components, either directly or indirectly, check here first to see if some",
    "category": "preferences"
  }
]